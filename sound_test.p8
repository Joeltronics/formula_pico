pico-8 cartridge // http://www.pico-8.com
version 41
__lua__

#include build/utils.p8.lua

pitch = 0
num_samples = 0

buf_addr = 0x8000
-- buf_size = 4
buf_size = 256

buf_zeros = 0x9000
buf_zeros_size = 1024

period = 10

vol = 255

cpu_update = nil


-- Take value in range [0, 255] and shift to range [-128, 127]
function u8_to_s8(val)
	return (val - 128) % 256  -- TESTME
	-- return val
end

-- Take value in range [-128, 127] and shift to range [0, 255]
function s8_to_u8(val)
	return (val + 128) % 256  -- TESTME
	-- return val
end

function _init()
	for n=0,255 do
		poke(buf_addr + n, u8_to_s8(n))
	end

	memset(buf_zeros, u8_to_s8(0), buf_zeros_size)
end

function _update60()

	if (btn(2)) vol += 1
	if (btn(3)) vol -= 1
	if (btnp(0)) period += 1
	if (btnp(1)) period -= 1

	period = clip_num(period, 2, buf_zeros_size)
	vol = clip_num(vol, 0, 255)


	num_samples = stat(109) - stat(108)

	local n = num_samples

	while n > 0 do
		serial(0x808, buf_addr + vol, 1)
		serial(0x808, buf_zeros, period - 1)
		n -= period

		-- serial(0x808, buf_addr + vol, 1)
		-- serial(0x808, buf_zeros, period - 1)
		-- serial(0x808, buf_addr + flr(vol/2), 1)
		-- serial(0x808, buf_zeros, period - 1)
		-- n -= 2*period
	end

	-- for i = 1,num_samples,buf_size do
	-- 	serial(0x808, buf_addr, buf_size)
	-- end

	cpu_update = stat(1)
end

function _draw()

	cls()

	-- TODO: draw waveform

	cursor(0, 32)
	-- print('pitch: ' .. pitch)
	print('period: ' .. period)
	print('freq: ' .. (5512.5 / period))
	print('vol: ' .. vol)
	print('')
	-- for n=46,56 do
	-- 	print('stat(' .. n .. ') = ' .. stat(n))
	-- end
	print('num_samples = ' .. num_samples)
	print('stat(108) = ' .. stat(108))
	print('stat(109) = ' .. stat(109))

	assert(cpu_update)
	local cpu = stat(1)
	local cpu_draw = cpu - cpu_update

	print('cpu_update = ' .. cpu_update * 100)
	print('cpu_draw = ' .. cpu_draw * 100)
	print('cpu = ' .. cpu * 100)

	cpu_update = nil
end

__gfx__
bbbbbbbbbb8888bbbbbbbbbbbbbbbbbbbbbb8888bbbbbbbbbbbbb000bbbbb888bbbbbbbbbbbbbbb000bbbb888bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbb000bbb88ee88bbb000bbbbbbb000bbbb88e888bb000bbbbbb06550bbb88e88bb000bbbbbbbb06550bb88e88bb000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bb065588888ee888885560bbbbb065588888ee888885560bbbbb000088888e888885560bbbbbbee0008888e888805560bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bb000e88888ee88888e000bbbbb00e088888e88888e0000bbbbb0e0088888e888880006bbbbbbeccc0888e8888800006bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bb000ecccccccccccce000bbbbb00eccccccccccccee000bbbbb0ecccccce8888e80006bbbbbbe111cccc8888e800006bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bb000e111111111111e000bbbbb00e111111111111ee000bbbbbbe111111cccccee0000bbbbbbe1111111ccccee00000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbb00e188111111881e00bbbbbbb0e188111111881e000bbbbbbbe18111111111ee000bbbb000b18811111111eee000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbb188881188881bbbbbbbbbbbb188881188881bbbbbbbb000018881188881ebbbbbbb6555018881188881eebbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
b0000088888558888800000bb0000088888558888800000b0655508888558888800000bb600008888558888800000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
00655588882662888855560006555588882662888055560060000888826628880555600b0000088826628880555600bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
06000088826006288800006060000088826006288000000000000888260062880000005000000222600628800000050bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
00000088226006228800000000000088226006228000000600000222260062280000056500000dd2600622800000565bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
00000022222662222200000000000022222662222000000600000ddddd662222000005650000000dd66222200000565bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
000000dddddddddddd000000000000ddddddddddd00000000000000bbbbddddd00000050b00000bbbbbdddd00000050bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
0000000bbbbbbbbbb00000000000000bbbbbbbbbb0000000b00000bbbbbbbbbb0000000bbbbbbbbbbbbbbbb0000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
b00000bbbbbbbbbbbb00000bb00000bbbbbbbbbbbb00000bbbbbbbbbbbbbbbbbb00000bbbbbbbbbbbbbbbbbb00000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb
0003000000000000444444440000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb00007777000077770000777700007777
0003000000000000455599940000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb00007777000077770000777700007777
0033000000000000495559940000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb00007777000077770000777700007777
0033300000000000499555940000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb00007777000077770000777700007777
0033300000000000499955540000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb77770000777700007777000077770000
033b300000000000499555940000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb77770000777700007777000077770000
03bb300000000000495559940000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb77770000777700007777000077770000
03bb330000000000455599940000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb66660000666600006666000066660000
03bbbb3000000000444444440000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82bbbb28bbbbbbbbbbbbbbbbbbbbbbbb
33bbb33300000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb882bb288bbbbbbbbbbbbbbbbbbbbbbbb
33bbb33500000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82822828bbbbbbbbbbbbbbbbbbbbbbbb
533b335500000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb8b2882b8bbbbbbbbbbbbbbbbbbbbbbbb
0533335000000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb8b2882b8bbbbbbbbbbbbbbbbbbbbbbbb
0055550000000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82822828bbbbbbbbbbbbbbbbbbbbbbbb
0004400000000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb882bb288bbbbbbbbbbbbbbbbbbbbbbbb
0004400000000000000660000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82bbbb28bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82bbbb28bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb882bb288bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82822828bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb8b2882b8bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb8b2882b8bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82822828bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb882bb288bbbbbbbbbbbbbbbbbbbbbbbb
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82bbbb28bbbbbbbbbbbbbbbbbbbbbbbb
0030b030b030003000dddd00ddd6605500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82bbbb28bbbbbbbbbbbbbbbbbbbbbbbb
033bb33bb33b0330666dfff0dd66665500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb882bb288bbbbbbbbbbbbbbbbbbbbbbbb
333b3333b33b33336c6dff66dd6cc65500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82822828bbbbbbbbbbbbbbbbbbbbbbbb
333333b3333333b3666dff66dd66665500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb8b2882b8bbbbbbbbbbbbbbbbbbbbbbbb
33bb33bb33bb3bbb6c6dff66dd6cc65500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb8b2882b8bbbbbbbbbbbbbbbbbbbbbbbb
3bb553bb3bb533b5666dff66dd66665500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82822828bbbbbbbbbbbbbbbbbbbbbbbb
b5553555b55555536c6dff66dd6cc65500000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb882bb288bbbbbbbbbbbbbbbbbbbbbbbb
0343034330430340666dff66dd66660000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb82bbbb28bbbbbbbbbbbbbbbbbbbbbbbb
__sfx__
017700011845200402004020040200402004020040200402004020040200402004020040200402004020040200402004020040200400004000040000400004000040000400004000040000400000000000000000
4b06000b0067034671006712467100671306710c671186711c6713067134671000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
490802030025001251012520000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
910802031c1501d1511d1520000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
011000010045200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
